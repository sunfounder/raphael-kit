 
.. _1.1.4_c:

1.1.4 Affichage 7 segments
=============================

Introduction
-----------------

Essayons de piloter un affichage à 7 segments pour afficher des chiffres de 0 à 9 et des lettres de A à F.

Composants nécessaires
------------------------------

Dans ce projet, nous avons besoin des composants suivants.

.. image:: ../img/list_7_segment.png

Il est certainement pratique d'acheter un kit complet, voici le lien :

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - Name	
        - ITEMS IN THIS KIT
        - LINK
    *   - Raphael Kit
        - 337
        - |link_Raphael_kit|

Vous pouvez également les acheter séparément via les liens ci-dessous.

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - INTRODUCTION DES COMPOSANTS
        - LIEN D'ACHAT

    *   - :ref:`cpn_gpio_extension_board`
        - |link_gpio_board_buy|
    *   - :ref:`cpn_breadboard`
        - |link_breadboard_buy|
    *   - :ref:`cpn_wires`
        - |link_wires_buy|
    *   - :ref:`cpn_resistor`
        - |link_resistor_buy|
    *   - :ref:`cpn_7_segment`
        - |link_7segment_buy|
    *   - :ref:`cpn_74hc595`
        - |link_74hc595_buy|

Schéma de câblage
---------------------

Connectez la broche ST_CP du 74HC595 à GPIO18 du Raspberry Pi, SH_CP à GPIO27, DS à GPIO17, 
les ports de sortie parallèles aux 8 segments de l'affichage LED. Les données sont entrées 
dans la broche DS vers le registre à décalage lorsque SH_CP (l'entrée d'horloge du registre 
à décalage) est en front montant, et vers le registre de mémoire lorsque ST_CP (l'entrée d'horloge
 de la mémoire) est en front montant. Vous pouvez alors contrôler les états de SH_CP et ST_CP via 
 les GPIO du Raspberry Pi pour transformer les données d'entrée série en données de sortie 
 parallèle afin d'économiser les GPIO du Raspberry Pi et piloter l'affichage.

============ ======== ======== ===
Nom T-Board  Physique wiringPi BCM
GPIO17       Pin 11   0        17
GPIO18       Pin 12   1        18
GPIO27       Pin 13   2        27
============ ======== ======== ===

.. image:: ../img/schematic_7_segment.png

Procédures expérimentales
------------------------------

**Étape 1 :** Construisez le circuit.

.. image:: ../img/image73.png

**Étape 2 :** Accédez au dossier du code.

.. raw:: html

   <run></run>

.. code-block::

    cd ~/raphael-kit/c/1.1.4/

**Étape 3 :** Compilez.

.. raw:: html

   <run></run>

.. code-block::

    gcc 1.1.4_7-Segment.c -lwiringPi

**Étape 4 :** Exécutez le fichier exécutable ci-dessus.

.. raw:: html

   <run></run>

.. code-block::

    sudo ./a.out

Après l'exécution du code, vous verrez l'affichage à 7 segments afficher 0-9, A-F.

.. note::

    Si cela ne fonctionne pas après l'exécution, ou s'il y a une erreur : \"wiringPi.h: No such file or directory\", veuillez vous référer à :ref:`install_wiringpi`.

**Code**

.. code-block:: c

    #include <wiringPi.h>
    #include <stdio.h>
    #define   SDI   0   //serial data input
    #define   RCLK  1   //memory clock input(STCP)
    #define   SRCLK 2   //shift register clock input(SHCP)
    unsigned char SegCode[16] = {0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};

    void init(void){
        pinMode(SDI, OUTPUT); 
        pinMode(RCLK, OUTPUT);
        pinMode(SRCLK, OUTPUT); 
        digitalWrite(SDI, 0);
        digitalWrite(RCLK, 0);
        digitalWrite(SRCLK, 0);
    }

    void hc595_shift(unsigned char dat){
        int i;
        for(i=0;i<8;i++){
            digitalWrite(SDI, 0x80 & (dat << i));
            digitalWrite(SRCLK, 1);
            delay(1);
            digitalWrite(SRCLK, 0);
        }
            digitalWrite(RCLK, 1);
            delay(1);
            digitalWrite(RCLK, 0);
    }

    int main(void){
        int i;
        if(wiringPiSetup() == -1){ //when initialize wiring failed, print messageto screen
            printf("setup wiringPi failed !");
            return 1;
        }
        init();
        while(1){
            for(i=0;i<16;i++){
                printf("Print %1X on Segment\n", i); // %X means hex output
                hc595_shift(SegCode[i]);
                delay(500);
            }
        }
        return 0;
    }

**Explication du code**


.. code-block:: c

    unsigned char SegCode[16] = {0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};

Un tableau de codes segment de 0 à F en hexadécimal (cathode commune).

.. code-block:: c

    void init(void){
        pinMode(SDI, OUTPUT); 
        pinMode(RCLK, OUTPUT); 
        pinMode(SRCLK, OUTPUT); 
        digitalWrite(SDI, 0);
        digitalWrite(RCLK, 0);
        digitalWrite(SRCLK, 0);
    }

Définir les broches ds, st_cp, sh_cp en sortie et l'état initial à 0.

.. code-block:: c

    void hc595_shift(unsigned char dat){}

Attribuer une valeur de 8 bits au registre à décalage du 74HC595.

.. code-block:: c

    digitalWrite(SDI, 0x80 & (dat << i));

Attribuer les données dat à SDI(DS) par bits. Supposons ici dat=0x3f(0011 1111), lorsque i=2, 0x3f sera décalé à gauche (<<) de 2 bits. 1111 1100 (0x3f << 2) & 1000 0000 (0x80) = 1000 0000, est vrai.

.. code-block:: c

    digitalWrite(SRCLK, 1);

La valeur initiale de SRCLK était définie à 0, et ici elle est définie à 1, ce qui génère une impulsion de front montant, puis décale les données DS vers le registre à décalage.

.. code-block:: c

    digitalWrite(RCLK, 1);

La valeur initiale de RCLK était définie à 0, et ici elle est définie à 1, ce qui génère une impulsion de front montant, puis décale les données du registre à décalage vers le registre de stockage.

.. code-block:: c

    while(1){
            for(i=0;i<16;i++){
                printf("Print %1X on Segment\n", i); // %X means hex output
                hc595_shift(SegCode[i]);
                delay(500);
            }
        }

Dans cette boucle for, nous utilisons ``%1X`` pour afficher i en tant que nombre hexadécimal. Appliquez i pour trouver le code segment correspondant dans le tableau ``SegCode[]``, et utilisez ``hc595_shift()`` pour passer le code SegCode dans le registre à décalage du 74HC595.

.. note::
    Le format hexadécimal des nombres 0~15 est (0, 1, 2, 3, 4, 5, 6, 7, 8, 9, A, B, C, D, E, F)

**Image du phénomène**

.. image:: ../img/image74.jpeg

