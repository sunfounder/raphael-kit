.. note::

    Ciao, benvenuto nella Community Facebook di appassionati SunFounder Raspberry Pi & Arduino & ESP32! Approfondisci Raspberry Pi, Arduino ed ESP32 con altri appassionati.

    **Perch√© unirsi?**

    - **Supporto esperto**: Risolvi problemi post-vendita e sfide tecniche con l'aiuto della nostra community e del nostro team.
    - **Impara e condividi**: Scambia suggerimenti e tutorial per migliorare le tue competenze.
    - **Anteprime esclusive**: Ottieni accesso anticipato agli annunci di nuovi prodotti e alle anteprime.
    - **Sconti speciali**: Goditi sconti esclusivi sui nostri prodotti pi√π recenti.
    - **Promozioni festive e giveaway**: Partecipa a giveaway e promozioni festive.

    üëâ Pronto a esplorare e creare con noi? Clicca [|link_sf_facebook|] e unisciti oggi stesso!

.. _2.2.1_py_pi5_mcp3008:

2.2.1 Fotoresistenza (MCP3008)
===============================

.. note::

   .. image:: ../img/mcp3008_and_adc0834.jpg
      :width: 25%
      :align: left
    

   A seconda della versione del kit, identifica se hai **ADC0834** o **MCP3008** e procedi con la sezione corrispondente.

Introduzione
------------

La fotoresistenza √® un componente comunemente usato per rilevare l'intensit√† della luce ambientale.  
Aiuta il controller a riconoscere il giorno e la notte e a realizzare funzioni di controllo della luce, come ad esempio una lampada notturna.  
Questo progetto √® molto simile a quello con il potenziometro, con la differenza che qui la variazione di tensione √® legata all'intensit√† luminosa.

Componenti richiesti
------------------------------

In questo progetto, abbiamo bisogno dei seguenti componenti. 

.. image:: ../python_pi5/img/list2_2.2.1_photoresistor.png

√à sicuramente comodo acquistare un kit completo, ecco il link: 

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - Nome	
        - ARTICOLI IN QUESTO KIT
        - LINK
    *   - Raphael Kit
        - 337
        - |link_Raphael_kit|

Puoi anche acquistarli separatamente dai link sottostanti.

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - INTRODUZIONE COMPONENTE
        - LINK DI ACQUISTO

    *   - :ref:`cpn_gpio_extension_board`
        - |link_gpio_board_buy|
    *   - :ref:`cpn_breadboard`
        - |link_breadboard_buy|
    *   - :ref:`cpn_wires`
        - |link_wires_buy|
    *   - :ref:`cpn_resistor`
        - |link_resistor_buy|
    *   - :ref:`cpn_led`
        - |link_led_buy|
    *   - :ref:`cpn_mcp3008`
        - \-
    *   - :ref:`cpn_photoresistor`
        - |link_photoresistor_buy|

Schema elettrico
-----------------

.. list-table::
    :widths: 30 30 30 30
    :header-rows: 1

    *   - Nome T-Board
        - fisico
        - WiringPi
        - BCM

    *   - SPICE0
        - pin24
        - 10
        - 8
    *   - SPIMOSI
        - pin19
        - 12
        - 10
    *   - SPIMISO
        - pin21
        - 13
        - 9
    *   - SPISCLK
        - pin23
        - 14
        - 11
    *   - GPIO22
        - pin15
        - 3
        - 22

.. image:: ../python_pi5/img/schematic_2.2.1_photoresistor_mcp3008.png

Procedure sperimentali
-----------------------

**Passo 1:** Costruisci il circuito.

.. image:: ../python_pi5/img/july24_2.2.1_photoresistor_mcp3008.png

**Passo 2:** Configura l'interfaccia SPI e installa la libreria ``spidev`` (vedi :ref:`spi_configuration` per istruzioni dettagliate).  
Se hai gi√† completato questi passaggi, puoi saltarli.

**Passo 3:** Vai alla cartella del codice.

.. raw:: html

   <run></run>

.. code-block::

    cd ~/raphael-kit/python-pi5

**Passo 4:** Esegui il file eseguibile.

.. raw:: html

   <run></run>

.. code-block::

    sudo python3 2.2.1-2_Photoresistor_zero.py

Quando il codice √® in esecuzione, la luminosit√† del LED cambier√† in base all'intensit√† della luce rilevata dalla fotoresistenza.

.. warning::

    Se compare l'errore ``RuntimeError: Cannot determine SOC peripheral base address``, fai riferimento a :ref:`faq_soc` 

**Codice**

.. note::

    Puoi **Modificare/Resettare/Copiare/Eseguire/Fermare** il codice qui sotto.  
    Prima, per√≤, devi andare al percorso del codice sorgente, ad esempio ``raphael-kit/python-pi5``.  
    Dopo aver modificato il codice, puoi eseguirlo direttamente per vederne l'effetto.

.. raw:: html

    <run></run>

.. code-block:: python

    #!/usr/bin/env python3
    import spidev
    import time
    from gpiozero import PWMLED

    # Inizializza un LED PWM sul pin GPIO 22
    led = PWMLED(22)

    # Inizializza la comunicazione SPI (Bus 0, CE0 -> GPIO8)
    spi = spidev.SpiDev()
    spi.open(0, 0)  # Bus 0, CS0
    spi.max_speed_hz = 1000000  # 1 MHz

    # Funzione per leggere da un canale MCP3008 (0‚Äì7)
    def read_adc(channel):
        """
        Legge un valore analogico da MCP3008 (0‚Äì1023)
        """
        if channel < 0 or channel > 7:
            return -1
        # Protocollo MCP3008: bit di avvio, modalit√† single-ended, canale (3 bit), filler
        r = spi.xfer2([1, (8 + channel) << 4, 0])
        value = ((r[1] & 3) << 8) | r[2]
        return value

    # Funzione per mappare i valori da un intervallo a un altro
    def MAP(x, in_min, in_max, out_min, out_max):
        return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min

    # Ciclo principale per leggere il valore ADC e controllare la luminosit√† del LED
    def loop():
        while True:
            # Legge il valore analogico dal canale 0 di MCP3008
            analogVal = read_adc(0)
            print('value = %d' % analogVal)

            # Mappa 0‚Äì1023 in intervallo PWM 0.0‚Äì1.0
            led.value = analogVal / 1023.0

            # Attende 0,2 secondi
            time.sleep(0.2)

    # Esegue il ciclo principale e gestisce l'interruzione KeyboardInterrupt
    try:
        loop()
    except KeyboardInterrupt:
        led.value = 0  # Spegne il LED prima di uscire

**Spiegazione del codice**

#. Questa parte importa la classe ``PWMLED`` dalla libreria ``gpiozero`` per il controllo dei LED PWM, ``spidev`` per la comunicazione SPI con MCP3008 e ``time`` per le funzioni di pausa/ritardo.

   .. code-block:: python

       import spidev
       import time
       from gpiozero import PWMLED

#. Inizializza un LED PWM collegato al pin GPIO 22 e configura l'interfaccia SPI per MCP3008 (Bus 0, CE0) con una velocit√† di 1 MHz.

   .. code-block:: python

       led = PWMLED(22)
       spi = spidev.SpiDev()
       spi.open(0, 0)
       spi.max_speed_hz = 1000000

#. Definisce una funzione per leggere un valore analogico da un canale specifico di MCP3008. Invia un comando di 3 byte tramite SPI e ricava un valore a 10 bit (0‚Äì1023) dalla risposta.

   .. code-block:: python

       def read_adc(channel):
           if channel < 0 or channel > 7:
               return -1
           r = spi.xfer2([1, (8 + channel) << 4, 0])
           value = ((r[1] & 3) << 8) | r[2]
           return value

#. Definisce una funzione ``MAP()`` di supporto per convertire un numero da un intervallo a un altro, utile per mappare i valori dell'ADC nell'intervallo PWM.

   .. code-block:: python

       def MAP(x, in_min, in_max, out_min, out_max):
           return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min

#. Implementa un ciclo che legge continuamente il valore analogico dal canale 0 di MCP3008, lo converte in un valore di luminosit√† PWM (0.0‚Äì1.0) e lo applica al LED. Il ciclo si interrompe per 0,2 secondi ad ogni iterazione.

   .. code-block:: python

       def loop():
           while True:
               analogVal = read_adc(0)
               print('value = %d' % analogVal)
               led.value = analogVal / 1023.0
               time.sleep(0.2)

#. Gestisce l'uscita con ``KeyboardInterrupt``. Quando l'utente interrompe il programma (Ctrl+C), il LED viene spento prima della chiusura.

   .. code-block:: python

       try:
           loop()
       except KeyboardInterrupt:
           led.value = 0
