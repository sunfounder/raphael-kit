.. note::

    Bonjour et bienvenue dans la communautÃ© SunFounder RaspberryÂ Pi & Arduino & ESP32 sur FacebookÂ ! 
    Plongez plus profondÃ©ment dans lâ€™univers RaspberryÂ Pi, Arduino et ESP32 avec dâ€™autres passionnÃ©s.

    **Pourquoi rejoindreÂ ?**

    - **Support dâ€™expertsÂ :** RÃ©solvez les problÃ¨mes aprÃ¨sâ€‘vente et les dÃ©fis techniques avec lâ€™aide de notre communautÃ© et de notre Ã©quipe.
    - **Apprendre et partagerÂ :** Ã‰changez des astuces et des tutoriels pour amÃ©liorer vos compÃ©tences.
    - **AperÃ§us exclusifsÂ :** Obtenez un accÃ¨s anticipÃ© aux annonces de nouveaux produits et aux avantâ€‘premiÃ¨res.
    - **RÃ©ductions spÃ©cialesÂ :** Profitez de remises exclusives sur nos derniers produits.
    - **Promotions et concours festifsÂ :** Participez Ã  des concours et promotions de vacances.

    ðŸ‘‰ PrÃªt Ã  explorer et crÃ©er avec nousÂ ? Cliquez sur [|link_sf_facebook|] et rejoignezâ€‘nous dÃ¨s aujourdâ€™huiÂ !

.. _4.1.11_py_pi5_mcp3008:

4.1.8 Indicateur de batterie (MCP3008)
======================================

.. note::

   .. image:: ../img/mcp3008_and_adc0834.jpg
      :width: 25%
      :align: left
    

   Selon la version de votre kit, veuillez identifier si vous avez **ADC0834** ou **MCP3008** et suivre la section correspondante.

Introduction
------------

Dans ce projet, nous allons rÃ©aliser un dispositif indicateur de batterie 
qui peut afficher visuellement le niveau de la batterie sur une barre de LED.

.. warning::

    Nâ€™utilisez pas de composants de batterie dÃ©passant 3,3Â V afin dâ€™Ã©viter toute surcharge, 
    ce qui pourrait endommager la puce ou le RaspberryÂ Pi.

Composants requis
-----------------

Dans ce projet, nous avons besoin des composants suivants.

.. image:: ../python_pi5/img/list2_Battery_Indicator.png
    :align: center

Il est Ã©videmment plus pratique dâ€™acheter un kit complet, voici le lienÂ : 

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - Nom
        - Ã‰LÃ‰MENTS DANS CE KIT
        - LIEN
    *   - Kit Raphael
        - 337
        - |link_Raphael_kit|

Vous pouvez Ã©galement les acheter sÃ©parÃ©ment via les liens ciâ€‘dessous.

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - INTRODUCTION DU COMPOSANT
        - LIEN Dâ€™ACHAT

    *   - :ref:`cpn_gpio_extension_board`
        - |link_gpio_board_buy|
    *   - :ref:`cpn_breadboard`
        - |link_breadboard_buy|
    *   - :ref:`cpn_wires`
        - |link_wires_buy|
    *   - :ref:`cpn_resistor`
        - |link_resistor_buy|
    *   - :ref:`cpn_bar_graph`
        - \-
    *   - :ref:`cpn_mcp3008`
        - \-

SchÃ©ma
------

============ ======== ======== ===
Nom T-Board  physique wiringPi BCM
SPICE0       Pin 24   10       8
SPIMOSI      Pin 19   12       10
SPIMISO      Pin 21   13       9
SPISCLK      Pin 23   14       11
GPIO25       Pin 22   6        25
GPIO12       Pin 32   26       12
GPIO16       Pin 36   27       16
GPIO20       Pin 38   28       20
GPIO21       Pin 40   29       21
GPIO5        Pin 29   21       5
GPIO6        Pin 31   22       6
GPIO13       Pin 33   23       13
GPIO19       Pin 35   24       19
GPIO26       Pin 37   25       26
============ ======== ======== ===

.. image:: ../python_pi5/img/schematic_battery_indicator_mcp3008.png
   :align: center
   :width: 800

ProcÃ©dure expÃ©rimentale
-----------------------

**Ã‰tapeÂ 1Â :** Construire le circuit.

.. image:: ../python_pi5/img/july24_3.1.5_battery_indicator_mcp3008.png
   :width: 800

**Ã‰tapeÂ 2Â :** Configurer lâ€™interface SPI et installer la bibliothÃ¨que ``spidev`` (voir :ref:`spi_configuration` pour des instructions dÃ©taillÃ©es).  
Si vous avez dÃ©jÃ  effectuÃ© ces Ã©tapes, vous pouvez les ignorer.

**Ã‰tapeÂ 3Â :** Aller dans le dossier du code.

.. raw:: html

    <run></run>

.. code-block::

    cd ~/raphael-kit/python-pi5

**Ã‰tapeÂ 4Â :** ExÃ©cuter le fichier.

.. raw:: html

    <run></run>

.. code-block::

    sudo python3 4.1.11-2_Battery_indicator_zero.py

AprÃ¨s exÃ©cution du programme, connectez sÃ©parÃ©ment le 3áµ‰Â broche du MCP3008 et la masse (GND) 
aux deux pÃ´les dâ€™une batterie. Vous verrez les LED correspondantes sur la barre LED sâ€™allumer 
pour afficher le niveau de la batterie (plage de mesureÂ : 0Â â€“Â 5Â V).

.. warning::

    Si une erreur Â«Â RuntimeError: Cannot determine SOC peripheral base addressÂ Â» apparaÃ®t, 
    veuillez vous rÃ©fÃ©rer Ã  :ref:`faq_soc`.

Code
----

.. note::
    Vous pouvez **Modifier/RÃ©initialiser/Copier/ExÃ©cuter/ArrÃªter** le code ciâ€‘dessous.  
    Mais avant cela, vous devez aller dans le chemin du code source comme ``raphael-kit/python-pi5``.  
    AprÃ¨s modification, vous pouvez exÃ©cuter directement le code pour voir lâ€™effet.

.. raw:: html

    <run></run>

.. code-block:: python

    #!/usr/bin/env python3
    ... (le code Python reste identique) ...

Explication du code
-------------------

Ce programme Python sâ€™exÃ©cute sur un RaspberryÂ Pi. 
Il utilise un convertisseur analogique-numÃ©rique MCP3008 pour lire des donnÃ©es de tempÃ©rature 
Ã  partir dâ€™un capteur analogique. Un joystick est utilisÃ© pour ajuster le seuil de tempÃ©rature, 
et un Ã©cran LCD1602 affiche la tempÃ©rature actuelle et le seuil. 
Un buzzer et une LED sont activÃ©s lorsque la tempÃ©rature dÃ©passe le seuil.

1. **Importer les bibliothÃ¨ques nÃ©cessaires**

   .. code-block:: python

       import RPi.GPIO as GPIO
       import spidev
       import time
       import math
       import LCD1602

   * ``RPi.GPIO`` contrÃ´le les broches GPIO.  
   * ``spidev`` communique avec le MCP3008 via SPI.  
   * ``math`` est utilisÃ© pour les calculs de tempÃ©rature.  
   * ``LCD1602`` contrÃ´le lâ€™afficheur LCD.

2. **Configuration GPIO**

   .. code-block:: python

       JOY_BTN_PIN = 22
       BUZZER_PIN = 23
       LED_PIN = 24

   * DÃ©finit les broches du bouton joystick, du buzzer et de la LED en numÃ©rotation BCM.

3. **Initialisation SPI et LCD**

   .. code-block:: python

       upperTem = 40
       spi = spidev.SpiDev()
       spi.open(0, 0)
       spi.max_speed_hz = 1000000
       LCD1602.init(0x27, 1)

   * Initialise la communication SPI avec MCP3008.  
   * Initialise lâ€™Ã©cran LCD1602 via I2C.

4. **Lecture dâ€™un canal ADC**

   .. code-block:: python

       def read_adc(channel):
           ...

   * Envoie des commandes SPI au MCP3008 et retourne une valeur de 0 Ã  1023.

5. **Lecture du joystick**

   .. code-block:: python

       def get_joystick_value():
           ...

   * Lit les mouvements du joystick et retourne un ajustement (+/-1 ou +/-10).

6. **Ajuster le seuil de tempÃ©rature**

   .. code-block:: python

       def upper_tem_setting():
           ...

   * Permet Ã  lâ€™utilisateur de modifier le seuil ``upperTem`` via le joystick.  
   * Met Ã  jour lâ€™affichage LCD.

7. **Conversion tempÃ©rature**

   .. code-block:: python

       def temperature():
           ...

   * Convertit la tension en rÃ©sistance, puis en tempÃ©rature (Ã©quation de Steinhart-Hart).

8. **Mode surveillance**

   .. code-block:: python

       def monitoring_temp():
           ...

   * Affiche la tempÃ©rature actuelle et le seuil.  
   * Active le buzzer et la LED si la tempÃ©rature dÃ©passe le seuil.

9. **Boucle principale**

   .. code-block:: python

       try:
           ...

   * Utilise un appui du joystick pour basculer entreÂ :  
     * ``stage 0``Â : surveillance  
     * ``stage 1``Â : ajustement du seuil.

10. **Nettoyage Ã  la sortie**

   .. code-block:: python

       except KeyboardInterrupt:
           ...
       finally:
           LCD1602.clear()
           GPIO.cleanup()
           spi.close()

   * Garantit la rÃ©initialisation des ressources Ã  la fin du programme (Ctrl+C).
