.. nota::

    ¬°Hola! Bienvenido a la comunidad de entusiastas de SunFounder Raspberry Pi, Arduino y ESP32 en Facebook. Profundiza en Raspberry Pi, Arduino y ESP32 junto a otros entusiastas.

    **¬øPor qu√© unirte?**

    - **Soporte experto**: Resuelve problemas postventa y desaf√≠os t√©cnicos con la ayuda de nuestra comunidad y equipo.
    - **Aprende y comparte**: Intercambia consejos y tutoriales para mejorar tus habilidades.
    - **Avances exclusivos**: Obt√©n acceso anticipado a anuncios de nuevos productos y adelantos exclusivos.
    - **Descuentos especiales**: Disfruta de descuentos exclusivos en nuestros productos m√°s nuevos.
    - **Promociones y sorteos festivos**: Participa en sorteos y promociones durante las festividades.

    üëâ ¬øListo para explorar y crear con nosotros? Haz clic en [|link_sf_facebook|] y √∫nete hoy mismo.

.. _4.1.8_py_pi5:

4.1.3 Bienvenida
======================

Introducci√≥n
-------------------

En este proyecto, utilizaremos un sensor PIR para detectar el movimiento de los peatones 
y usaremos servos, LED y un zumbador para simular el funcionamiento de la puerta autom√°tica 
de una tienda de conveniencia. Cuando un peat√≥n aparezca dentro del rango de detecci√≥n del 
PIR, la luz indicadora se encender√°, la puerta se abrir√° y el zumbador reproducir√° un timbre 
de apertura.



Componentes necesarios
--------------------------

En este proyecto, necesitamos los siguientes componentes.

.. image:: ../python_pi5/img/4.1.8_welcome_list.png
    :width: 800
    :align: center

Es definitivamente conveniente comprar un kit completo, aqu√≠ tienes el enlace:

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - Nombre	
        - ELEMENTOS EN ESTE KIT
        - ENLACE
    *   - Kit Raphael
        - 337
        - |link_Raphael_kit|

Tambi√©n puedes comprarlos por separado en los enlaces a continuaci√≥n.

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - INTRODUCCI√ìN DEL COMPONENTE
        - ENLACE DE COMPRA

    *   - :ref:`cpn_gpio_extension_board`
        - |link_gpio_board_buy|
    *   - :ref:`cpn_breadboard`
        - |link_breadboard_buy|
    *   - :ref:`cpn_wires`
        - |link_wires_buy|
    *   - :ref:`cpn_resistor`
        - |link_resistor_buy|
    *   - :ref:`cpn_led`
        - |link_led_buy|
    *   - :ref:`cpn_pir`
        - \-
    *   - :ref:`cpn_servo`
        - |link_servo_buy|
    *   - :ref:`cpn_buzzer`
        - |link_passive_buzzer_buy|
    *   - :ref:`cpn_transistor`
        - |link_transistor_buy|


Diagrama Esquem√°tico
---------------------------

==================== ====== ======== ===
Nombre de la T-Board f√≠sica wiringPi BCM
GPIO18               Pin 12 1        18
GPIO17               Pin 11 0        17
GPIO27               Pin 13 2        27
GPIO22               Pin 15 3        22
==================== ====== ======== ===

.. image:: ../python_pi5/img/4.1.8_welcome_schematic.png
   :align: center

Procedimientos Experimentales
--------------------------------

**Paso 1:** Monta el circuito.

.. image:: ../python_pi5/img/4.1.8_welcome_circuit.png
    :align: center

**Paso 2:** Cambia de directorio.

.. raw:: html

   <run></run>

.. code-block::

    cd ~/raphael-kit/python-pi5

**Paso 3:** Ejecuta.

.. raw:: html

   <run></run>

.. code-block::

    sudo python3 4.1.8_Welcome_zero.py

Despu√©s de ejecutar el c√≥digo, si el sensor PIR detecta que alguien pasa, 
la puerta se abrir√° autom√°ticamente (simulada por el servo), se encender√° 
la luz indicadora y sonar√° el timbre de la puerta. Una vez que el timbre 
suene, el sistema cerrar√° autom√°ticamente la puerta y apagar√° la luz indicadora, 
esperando a que alguien pase de nuevo.

Hay dos potenci√≥metros en el m√≥dulo PIR: uno para ajustar la sensibilidad y otro 
para ajustar la distancia de detecci√≥n. Para que el m√≥dulo PIR funcione mejor, 
debes girar ambos en sentido antihorario hasta el final.

.. image:: ../python_pi5/img/4.1.8_PIR_TTE.png
    :width: 400
    :align: center

**C√≥digo**

.. nota::
    Puedes **Modificar/Restablecer/Copiar/Ejecutar/Detener** el c√≥digo a continuaci√≥n. Pero antes de eso, debes ir a la ruta del c√≥digo fuente como ``raphael-kit/python-pi5``. Despu√©s de modificar el c√≥digo, puedes ejecutarlo directamente para ver el efecto.

.. raw:: html

    <run></run>

.. code-block:: python

   #!/usr/bin/env python3

   from gpiozero import LED, MotionSensor, Servo, TonalBuzzer
   import time

   # Configuraci√≥n de pines GPIO para LED, sensor de movimiento (PIR) y zumbador
   ledPin = LED(6)
   pirPin = MotionSensor(21)
   buzPin = TonalBuzzer(27)

   # Factor de correcci√≥n de ancho de pulso del motor servo y c√°lculo
   myCorrection = 0.45
   maxPW = (2.0 + myCorrection) / 1000  # Ancho de pulso m√°ximo
   minPW = (1.0 - myCorrection) / 1000  # Ancho de pulso m√≠nimo

   # Inicializar servo con anchos de pulso personalizados
   servoPin = Servo(25, min_pulse_width=minPW, max_pulse_width=maxPW)

   # Melod√≠a musical para el zumbador, con notas y duraciones
   tune = [('C#4', 0.2), ('D4', 0.2), (None, 0.2),
           ('Eb4', 0.2), ('E4', 0.2), (None, 0.6),
           ('F#4', 0.2), ('G4', 0.2), (None, 0.6),
           ('Eb4', 0.2), ('E4', 0.2), (None, 0.2),
           ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
           ('C4', 0.2), ('B4', 0.2), (None, 0.2),
           ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
           ('B4', 0.2), ('Bb4', 0.5), (None, 0.6),
           ('A4', 0.2), ('G4', 0.2), ('E4', 0.2), 
           ('D4', 0.2), ('E4', 0.2)]

   def setAngle(angle):
       """
       Move the servo to a specified angle.
       :param angle: Angle in degrees (0-180).
       """
       value = float(angle / 180)  # Convertir √°ngulo a valor de servo
       servoPin.value = value      # Establecer posici√≥n del servo
       time.sleep(0.001)           # Breve pausa para el movimiento del servo

   def doorbell():
       """
       Play a musical tune using the buzzer.
       """
       for note, duration in tune:
           buzPin.play(note)       # Reproducir la nota
           time.sleep(float(duration))  # Duraci√≥n de la nota
       buzPin.stop()               # Detener el zumbador despu√©s de la melod√≠a

   def closedoor():
       # Apaga el LED y mueve el servo para cerrar la puerta
       ledPin.off()
       for i in range(180, -1, -1):
           setAngle(i)             # Mover servo de 180 a 0 grados
           time.sleep(0.001)       # Breve pausa para movimiento suave
       time.sleep(1)               # Esperar despu√©s de cerrar la puerta

   def opendoor():
       # Encender LED, abrir puerta (mover servo), reproducir melod√≠a, cerrar puerta
       ledPin.on()
       for i in range(0, 181):
           setAngle(i)             # Mover servo de 0 a 180 grados
           time.sleep(0.001)       # Breve pausa para movimiento suave
       time.sleep(1)               # Esperar antes de reproducir la melod√≠a
       doorbell()                  # Reproducir la melod√≠a del timbre
       closedoor()                 # Cerrar la puerta despu√©s de la melod√≠a

   def loop():
       # Bucle principal para verificar movimiento y operar la puerta
       while True:
           if pirPin.motion_detected:
               opendoor()               # Abrir puerta si se detecta movimiento
           time.sleep(0.1)              # Breve pausa en el bucle

   try:
       loop()
   except KeyboardInterrupt:
       # Limpiar GPIO al interrumpir el usuario (por ejemplo, Ctrl+C)
       buzPin.stop()
       ledPin.off()


**Explicaci√≥n del C√≥digo**

#. El script comienza importando los m√≥dulos necesarios. La biblioteca ``gpiozero`` se utiliza para interactuar con el LED, el sensor de movimiento, el motor servo y el zumbador tonal. El m√≥dulo ``time`` se utiliza para funciones relacionadas con el tiempo.

   .. code-block:: python

       #!/usr/bin/env python3
       from gpiozero import LED, MotionSensor, Servo, TonalBuzzer
       import time

#. Inicializa el LED, el sensor de movimiento PIR y el zumbador tonal en sus respectivos pines GPIO.

   .. code-block:: python

       # Configuraci√≥n de pines GPIO para LED, sensor de movimiento (PIR) y zumbador
       ledPin = LED(6)
       pirPin = MotionSensor(21)
       buzPin = TonalBuzzer(27)

#. Calcula los anchos de pulso m√°ximos y m√≠nimos para el motor servo, incorporando un factor de correcci√≥n para un ajuste fino.

   .. code-block:: python

       # Factor de correcci√≥n de ancho de pulso del motor servo y c√°lculo
       myCorrection = 0.45
       maxPW = (2.0 + myCorrection) / 1000  # Ancho de pulso m√°ximo
       minPW = (1.0 - myCorrection) / 1000  # Ancho de pulso m√≠nimo

#. Inicializa el motor servo en el pin GPIO 25 con los anchos de pulso personalizados para una posici√≥n precisa.

   .. code-block:: python

       # Inicializar servo con anchos de pulso personalizados
       servoPin = Servo(25, min_pulse_width=minPW, max_pulse_width=maxPW)

#. La melod√≠a se define como una secuencia de notas (frecuencia) y duraciones (segundos).

   .. code-block:: python

       # Melod√≠a musical para el zumbador, con notas y duraciones
       tune = [('C#4', 0.2), ('D4', 0.2), (None, 0.2),
               ('Eb4', 0.2), ('E4', 0.2), (None, 0.6),
               ('F#4', 0.2), ('G4', 0.2), (None, 0.6),
               ('Eb4', 0.2), ('E4', 0.2), (None, 0.2),
               ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
               ('C4', 0.2), ('B4', 0.2), (None, 0.2),
               ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
               ('B4', 0.2), ('Bb4', 0.5), (None, 0.6),
               ('A4', 0.2), ('G4', 0.2), ('E4', 0.2), 
               ('D4', 0.2), ('E4', 0.2)]

#. Funci√≥n para mover el servo a un √°ngulo especificado. Convierte el √°ngulo a un valor entre 0 y 1 para el servo.

   .. code-block:: python

       def setAngle(angle):
           """
           Move the servo to a specified angle.
           :param angle: Angle in degrees (0-180).
           """
           value = float(angle / 180)  # Convertir √°ngulo a valor de servo
           servoPin.value = value      # Establecer posici√≥n del servo
           time.sleep(0.001)           # Breve pausa para el movimiento del servo

#. Funci√≥n para reproducir una melod√≠a musical utilizando el zumbador. Itera a trav√©s de la lista ``tune``, reproduciendo cada nota por su duraci√≥n especificada.

   .. code-block:: python

       def doorbell():
           """
           Play a musical tune using the buzzer.
           """
           for note, duration in tune:
               buzPin.play(note)       # Reproducir la nota
               time.sleep(float(duration))  # Duraci√≥n de la nota
           buzPin.stop()               # Detener zumbador despu√©s de la melod√≠a

#. Funciones para abrir y cerrar la puerta utilizando el motor servo. La funci√≥n ``opendoor`` enciende el LED, abre la puerta, reproduce la melod√≠a y luego cierra la puerta.

   .. code-block:: python

       def closedoor():
           # Apaga el LED y mueve el servo para cerrar la puerta
           ledPin.off()
           for i in range(180, -1, -1):
               setAngle(i)             # Mover servo de 180 a 0 grados
               time.sleep(0.001)       # Breve pausa para movimiento suave
           time.sleep(1)               # Esperar despu√©s de cerrar la puerta

       def opendoor():
           # Encender LED, abrir puerta (mover servo), reproducir melod√≠a, cerrar puerta
           ledPin.on()
           for i in range(0, 181):
               setAngle(i)             # Mover servo de 0 a 180 grados
               time.sleep(0.001)       # Breve pausa para movimiento suave
           time.sleep(1)               # Esperar antes de reproducir la melod√≠a
           doorbell()                  # Reproducir la melod√≠a del timbre
           closedoor()                 # Cerrar la puerta despu√©s de la melod√≠a

#. Bucle principal que verifica constantemente la detecci√≥n de movimiento. Cuando se detecta movimiento, se activa la funci√≥n ``opendoor``.

   .. code-block:: python

       def loop():
           # Bucle principal para verificar movimiento y operar la puerta
           while True:
               if pirPin.motion_detected:
                   opendoor()               # Abrir puerta si se detecta movimiento
               time.sleep(0.1)              # Breve pausa en el bucle

#. Ejecuta el bucle principal y asegura que el script se pueda detener con un comando de teclado (Ctrl+C), apagando el zumbador y el LED para una salida limpia.

   .. code-block:: python

       try:
           loop()
       except KeyboardInterrupt:
           # Limpiar GPIO al interrumpir el usuario (por ejemplo, Ctrl+C)
           buzPin.stop()
           ledPin.off()

