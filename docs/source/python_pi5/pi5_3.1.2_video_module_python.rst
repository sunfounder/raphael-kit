.. note::

    춰Hola! Bienvenido a la comunidad de entusiastas de SunFounder Raspberry Pi & Arduino & ESP32 en Facebook. Sum칠rgete en el mundo de Raspberry Pi, Arduino y ESP32 junto con otros entusiastas.

    **쯇or qu칠 unirse?**

    - **Soporte experto**: Resuelve problemas postventa y desaf칤os t칠cnicos con la ayuda de nuestra comunidad y equipo.
    - **Aprende y comparte**: Intercambia consejos y tutoriales para mejorar tus habilidades.
    - **Preestrenos exclusivos**: Accede anticipadamente a anuncios de nuevos productos y adelantos.
    - **Descuentos especiales**: Disfruta de descuentos exclusivos en nuestros productos m치s nuevos.
    - **Promociones festivas y sorteos**: Participa en sorteos y promociones de temporada.

    游녤 쯃isto para explorar y crear con nosotros? Haz clic en [|link_sf_facebook|] y 칰nete hoy mismo.

.. _3.1.2_py_pi5:

3.1.2 M칩dulo de Video
========================

Introducci칩n
---------------

Adem치s de tomar fotos, el m칩dulo de c치mara tambi칠n puede usarse para grabar videos.

Componentes Requeridos
-------------------------

En este proyecto, necesitamos los siguientes componentes.

.. image:: ../python_pi5/img/3.3.2_photograph_list.png
  :width: 800

Es definitivamente conveniente comprar un kit completo, aqu칤 est치 el enlace:

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - Nombre
        - ART칈CULOS EN ESTE KIT
        - ENLACE
    *   - Raphael Kit
        - 337
        - |link_Raphael_kit|

Tambi칠n puedes comprarlos por separado en los siguientes enlaces.

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - INTRODUCCI칍N DEL COMPONENTE
        - ENLACE DE COMPRA

    *   - :ref:`cpn_camera_module`
        - |link_camera_buy|

Procedimientos Experimentales
---------------------------------

**Paso 1:** Entra en el escritorio de Raspberry Pi. Puede que necesites una pantalla para una mejor experiencia, consulta: `Conecta tu Raspberry Pi <https://projects.raspberrypi.org/en/projects/raspberry-pi-setting-up/3>`_. O accede al escritorio de Raspberry Pi de forma remota, para un tutorial detallado, consulta :ref:`remote_desktop`.

**Paso 2:** Abre una terminal y accede a la carpeta del c칩digo.


.. code-block::

    cd ~/raphael-kit/python-pi5

**Paso 3:** Ejecuta.


.. code-block::

    sudo python3 3.1.2_VideoModule_zero.py

Ejecuta el c칩digo para comenzar a grabar. Presiona ``Ctrl+C`` para finalizar la grabaci칩n. Nombra el video ``my_video.h264`` y gu치rdalo en el directorio ``~``.

.. note::

    Tambi칠n puedes abrir ``3.1.2_PhotographModule_zero.py`` en la ruta ``~/raphael-kit/python-pi5`` con un IDE de Python, haz clic en el bot칩n de ejecutar para iniciar y det칠n el c칩digo con el bot칩n de detener.

Si deseas enviar fotos a tu PC, consulta :ref:`filezilla`.

.. warning::

    Si recibe el mensaje de error ``RuntimeError: Cannot determine SOC peripheral base address``, consulte :ref:`faq_soc`


**C칩digo**

.. code-block:: python

   #!/usr/bin/env python3

   import time
   from picamera2 import Picamera2, Preview
   from picamera2.encoders import H264Encoder
   from picamera2.outputs import FfmpegOutput
   import os

   # Obtener el nombre de usuario actual
   user = os.getlogin()
   # Obtener la ruta del directorio home del usuario
   user_home = os.path.expanduser(f'~{user}')

   # Crear una instancia de Picamera2
   camera = Picamera2()
   # Recuperar la configuraci칩n de vista previa predeterminada
   preview_config = camera.preview_configuration

   try:
       # Configurar tama침o y formato de vista previa
       preview_config.size = (800, 600)
       preview_config.format = 'XRGB8888'
       # Iniciar la vista previa de la c치mara en modo QTGL
       camera.start_preview(Preview.QTGL)

       # Definir configuraci칩n de video con tama침o, velocidad de fotogramas y recuento de b칰fer
       conf = {'size': (800, 600)}
       controls = {'FrameRate': 40}
       config = camera.create_video_configuration(main=conf, controls=controls, buffer_count=12)
       # Crear un codificador de video con una tasa de bits especificada
       encoder = H264Encoder(bitrate=10000000)
       # Definir el archivo de salida para el video
       output = FfmpegOutput(f'{user_home}/my_video.mp4')
       # Configurar e iniciar la grabaci칩n
       camera.configure(config)
       camera.start_recording(encoder, output)
       # Grabar durante 10 segundos
       time.sleep(10)
       # Detener la grabaci칩n
       camera.stop_recording()

   except KeyboardInterrupt:
       # Detener la vista previa de la c치mara si ocurre una interrupci칩n de teclado (e.g., Ctrl+C)
       camera.stop_preview()
       pass


**Explicaci칩n del C칩digo**

#. Importa las bibliotecas y clases necesarias. La biblioteca ``picamera2`` se usa para el control de la c치mara, ``H264Encoder`` para la codificaci칩n de video, y ``FfmpegOutput`` para definir el archivo de salida del video.

   .. code-block:: python

       #!/usr/bin/env python3

       import time
       from picamera2 import Picamera2, Preview
       from picamera2.encoders import H264Encoder
       from picamera2.outputs import FfmpegOutput
       import os

#. Recupera el nombre de usuario actual y la ruta a su directorio home.

   .. code-block:: python

       # Obtener el nombre de usuario actual
       user = os.getlogin()
       # Obtener la ruta del directorio home del usuario
       user_home = os.path.expanduser(f'~{user}')

#. Crea una instancia de la clase ``Picamera2`` y recupera la configuraci칩n de vista previa predeterminada.

   .. code-block:: python

       # Crear una instancia de Picamera2
       camera = Picamera2()
       # Recuperar la configuraci칩n de vista previa predeterminada
       preview_config = camera.preview_configuration

#. Establece el tama침o y formato de la vista previa de la c치mara. El tama침o se establece en 800x600 p칤xeles, y el formato se establece en ``XRGB8888``.

   .. code-block:: python

       try:
           # Configurar tama침o y formato de vista previa
           preview_config.size = (800, 600)
           preview_config.format = 'XRGB8888'
           
#. Inicia la vista previa de la c치mara en modo QTGL, un modo de vista previa gr치fica.

   .. code-block:: python

       try:
           ...          
             
           # Iniciar la vista previa de la c치mara en modo QTGL
           camera.start_preview(Preview.QTGL)
           
           ...

#. Define la configuraci칩n del video con un tama침o de cuadro de 800x600 p칤xeles y una velocidad de fotogramas de 40 cuadros por segundo.

   .. code-block:: python

       try:
           ...
           
           # Definir configuraci칩n de video con tama침o, velocidad de fotogramas y recuento de b칰fer
           conf = {'size': (800, 600)}
           controls = {'FrameRate': 40}
           config = camera.create_video_configuration(main=conf, controls=controls, buffer_count=12)
           
           ...

#. Crea un codificador de video con una tasa de bits especificada de 10 Mbps, usando el formato de codificaci칩n H.264. Configura la ruta del archivo de salida para el video, guard치ndolo como ``my_video.mp4`` en el directorio home del usuario.

   .. code-block:: python

       try:
           ...

           # Crear un codificador de video con una tasa de bits especificada
           encoder = H264Encoder(bitrate=10000000)
           # Definir el archivo de salida para el video
           output = FfmpegOutput(f'{user_home}/my_video.mp4')
           
           ...

#. Configura la c치mara con los ajustes de video definidos, inicia la grabaci칩n usando el codificador y el archivo de salida especificados, graba durante 10 segundos y luego detiene la grabaci칩n.

   .. code-block:: python

       try:
           ...

           # Configurar e iniciar la grabaci칩n
           camera.configure(config)
           camera.start_recording(encoder, output)
           # Grabar durante 10 segundos
           time.sleep(10)
           # Detener la grabaci칩n
           camera.stop_recording()

#. Este bloque de c칩digo maneja una interrupci칩n de teclado (como Ctrl+C) deteniendo la vista previa de la c치mara. La declaraci칩n ``pass`` se usa para manejar la excepci칩n sin hacer nada m치s.

   .. code-block:: python

       except KeyboardInterrupt:
           # Detener la vista previa de la c치mara si ocurre una interrupci칩n de teclado (e.g., Ctrl+C)
           camera.stop_preview()
           pass







