.. note::

    ¬°Hola, bienvenido a la comunidad de entusiastas de SunFounder Raspberry Pi & Arduino & ESP32 en Facebook! Sum√©rgete m√°s en Raspberry Pi, Arduino y ESP32 con otros entusiastas.

    **¬øPor qu√© unirse?**

    - **Soporte experto**: Resuelve problemas postventa y desaf√≠os t√©cnicos con la ayuda de nuestra comunidad y equipo.
    - **Aprende y comparte**: Intercambia consejos y tutoriales para mejorar tus habilidades.
    - **Avances exclusivos**: Obt√©n acceso anticipado a nuevos anuncios de productos y adelantos.
    - **Descuentos especiales**: Disfruta de descuentos exclusivos en nuestros productos m√°s recientes.
    - **Promociones festivas y sorteos**: Participa en sorteos y promociones de temporada.

    üëâ ¬øListo para explorar y crear con nosotros? Haz clic en [|link_sf_facebook|] y √∫nete hoy mismo.

.. _3.1.5_c_pi5_mcp3008:

3.1.5 Indicador de Bater√≠a (MCP3008)
====================================

.. note::

   .. image:: ../img/mcp3008_and_adc0834.jpg
      :width: 25%
      :align: left
    

   Dependiendo de la versi√≥n de tu kit, identifica si tienes **ADC0834** o **MCP3008** y procede con la secci√≥n correspondiente.

Introducci√≥n
------------

En este proyecto, realizaremos un dispositivo indicador de bater√≠a que puede mostrar visualmente el nivel de la bater√≠a en la barra de LED (LED Bargraph).

.. warning::

    No utilices componentes de bater√≠a que excedan los 3.3V para evitar sobrecargas que puedan da√±ar el chip o la Raspberry Pi.

Componentes requeridos
----------------------

En este proyecto necesitamos los siguientes componentes.

.. image:: ../img/list2_Battery_Indicator.png
    :align: center

Es definitivamente conveniente comprar un kit completo, aqu√≠ est√° el enlace: 

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - Nombre	
        - ART√çCULOS EN ESTE KIT
        - ENLACE
    *   - Kit Raphael
        - 337
        - |link_Raphael_kit|

Tambi√©n puedes comprarlos por separado en los siguientes enlaces.

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - INTRODUCCI√ìN DEL COMPONENTE
        - ENLACE DE COMPRA

    *   - :ref:`cpn_gpio_extension_board`
        - |link_gpio_board_buy|
    *   - :ref:`cpn_breadboard`
        - |link_breadboard_buy|
    *   - :ref:`cpn_wires`
        - |link_wires_buy|
    *   - :ref:`cpn_resistor`
        - |link_resistor_buy|
    *   - :ref:`cpn_bar_graph`
        - \-
    *   - :ref:`mcp3008`
        - \-

Diagrama esquem√°tico
--------------------

============ ======== ======== ===
Nombre T-Board physical wiringPi BCM
SPICE0       Pin 24   10       8
SPIMOSI      Pin 19   12       10
SPIMISO      Pin 21   13       9
SPISCLK      Pin 23   14       11
GPIO25       Pin 22   6        25
GPIO12       Pin 32   26       12
GPIO16       Pin 36   27       16
GPIO20       Pin 38   28       20
GPIO21       Pin 40   29       21
GPIO5        Pin 29   21       5
GPIO6        Pin 31   22       6
GPIO13       Pin 33   23       13
GPIO19       Pin 35   24       19
GPIO26       Pin 37   25       26
============ ======== ======== ===

.. image:: ../img/schematic_battery_indicator_mcp3008.png
   :align: center

Procedimientos experimentales
-----------------------------

**Paso 1:** Construye el circuito.

.. image:: ../img/july24_3.1.5_battery_indicator_mcp3008.png

**Paso 2:** Ve a la carpeta del c√≥digo.

.. raw:: html

   <run></run>

.. code-block:: 

    cd ~/raphael-kit/c/3.1.5-2/

**Paso 3:** Compila el c√≥digo.

.. raw:: html

   <run></run>

.. code-block:: 

    gcc 3.1.5_BatteryIndicator.c -lwiringPi

**Paso 4:** Ejecuta el archivo compilado.

.. raw:: html

   <run></run>

.. code-block:: 

    sudo ./a.out

Despu√©s de que el programa se ejecute, conecta un cable desde el pin 3 del MCP3008 y otro desde el GND a los dos polos de una bater√≠a.  
Ver√°s que los LED correspondientes en la barra LED se encienden para mostrar el nivel de energ√≠a (rango de medici√≥n: 0-5V).

.. note::

    Si no funciona despu√©s de ejecutarlo, o aparece un mensaje de error: \"wiringPi.h: No such file or directory\", por favor consulta :ref:`install_wiringpi`.

C√≥digo
------

.. code-block:: c

    #include <wiringPi.h>
    #include <wiringPiSPI.h>
    #include <stdio.h>

    #define SPI_CHANNEL 0
    #define SPI_SPEED   1000000  // 1MHz
    #define VREF        3.3      

    int pins[10] = {6, 26, 27, 28, 29, 21, 22, 23, 24, 25};

    int read_ADC(int channel)
    {
        if (channel < 0 || channel > 7) return -1;

        unsigned char buffer[3];
        buffer[0] = 1;  // Bit de inicio
        buffer[1] = (8 + channel) << 4;  // Modo de un solo extremo
        buffer[2] = 0;

        wiringPiSPIDataRW(SPI_CHANNEL, buffer, 3);

        int value = ((buffer[1] & 3) << 8) | buffer[2];
        return value;
    }

    void LedBarGraph(int value) {
        for (int i = 0; i < 10; i++) {
            if (i < value)
                digitalWrite(pins[i], HIGH);  
            else
                digitalWrite(pins[i], LOW);
        }
    }

    int main(void)
    {
        if (wiringPiSetup() == -1) {
            printf("¬°Error al configurar wiringPi!\n");
            return 1;
        }

        if (wiringPiSPISetup(SPI_CHANNEL, SPI_SPEED) == -1) {
            printf("¬°Error al configurar SPI!\n");
            return 1;
        }

        for (int i = 0; i < 10; i++) {
            pinMode(pins[i], OUTPUT);
            digitalWrite(pins[i], HIGH);
        }

        while (1) {
            int analogVal = read_ADC(0);  // MCP3008 CH0
            if (analogVal < 0) continue;

            float voltage = analogVal * VREF / 1023.0;
            int level = analogVal * 10 / 1024;  
            if (level > 10) level = 10;  

            LedBarGraph(level);

            printf("Valor ADC: %d\tVoltaje: %.2f V\tNivel: %d\n", analogVal, voltage, level);

            delay(200);
        }

        return 0;
    }

Explicaci√≥n del c√≥digo
----------------------

.. code-block:: c

    int read_ADC(int channel) { ... }

Esta funci√≥n lee valores anal√≥gicos del chip ADC MCP3008 usando SPI.  
El par√°metro `channel` selecciona una de las 8 entradas anal√≥gicas (CH0‚ÄìCH7).  
El MCP3008 devuelve un valor digital de 10 bits entre 0 y 1023 que representa el voltaje anal√≥gico.

.. code-block:: c

    void LedBarGraph(int value) { ... }

Esta funci√≥n controla una barra de LED de 10 segmentos.  
Cada LED representa 1/10 del rango de voltaje.  
Los LED se encienden en orden hasta el nivel especificado.

Nota: Esta versi√≥n asume que los √°nodos de los LED est√°n conectados a los GPIOs y los c√°todos a GND (es decir, activos en HIGH).

.. code-block:: c

    int main(void) { ... }

L√≥gica principal del programa:

- Inicializa wiringPi y la comunicaci√≥n SPI.  
- Configura los pines GPIO como salidas para controlar la barra LED de 10 segmentos.  
- Lee continuamente el voltaje anal√≥gico a trav√©s del MCP3008 (CH0).  
- Convierte la lectura en voltaje usando `VREF = 3.3V`.  
- Escala el voltaje a un nivel de 0‚Äì10 y enciende los LED correspondientes.  
- Muestra en consola el valor crudo del ADC, el voltaje (en voltios) y el nivel del LED.  

Esto act√∫a como un indicador visual de nivel de bater√≠a o volt√≠metro anal√≥gico.

.. **Imagen del fen√≥meno**

.. .. image:: ../img/image249.jpeg
   :align: center
