.. note::

    ã“ã‚“ã«ã¡ã¯ã€SunFounderã®Raspberry Pi & Arduino & ESP32æ„›å¥½å®¶ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã‚ˆã†ã“ãï¼Facebookä¸Šã§Raspberry Piã€Arduinoã€ESP32ã«ã¤ã„ã¦ã‚‚ã£ã¨æ·±ãæ˜ã‚Šä¸‹ã’ã€ä»–ã®æ„›å¥½å®¶ã¨äº¤æµã—ã¾ã—ã‚‡ã†ã€‚

    **å‚åŠ ã™ã‚‹ç†ç”±ã¯ï¼Ÿ**

    - **ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã‚µãƒãƒ¼ãƒˆ**ï¼šã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚„ãƒãƒ¼ãƒ ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€è²©å£²å¾Œã®å•é¡Œã‚„æŠ€è¡“çš„ãªèª²é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚
    - **å­¦ã³ï¼†å…±æœ‰**ï¼šãƒ’ãƒ³ãƒˆã‚„ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’äº¤æ›ã—ã¦ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚
    - **ç‹¬å çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**ï¼šæ–°è£½å“ã®ç™ºè¡¨ã‚„å…ˆè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æ—©æœŸã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚
    - **ç‰¹åˆ¥å‰²å¼•**ï¼šæœ€æ–°è£½å“ã®ç‹¬å å‰²å¼•ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚
    - **ç¥­ã‚Šã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚®ãƒ•ãƒˆ**ï¼šã‚®ãƒ•ãƒˆã‚„ç¥æ—¥ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ã€‚

    ğŸ‘‰ ç§ãŸã¡ã¨ä¸€ç·’ã«æ¢ç´¢ã—ã€å‰µé€ ã™ã‚‹æº–å‚™ã¯ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ[|link_sf_facebook|]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»Šã™ãå‚åŠ ã—ã¾ã—ã‚‡ã†ï¼

.. _2.2.8_c_pi5:

2.2.8 è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
====================================

ã¯ã˜ã‚ã«
--------------

è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ¤œå‡ºã‚„è·é›¢ã®æ¸¬å®šã«è¶…éŸ³æ³¢ã‚’ä½¿ç”¨ã—ã¦æ­£ç¢ºã«è¡Œã„ã¾ã™ã€‚è¶…éŸ³æ³¢æ³¢ã‚’é€ä¿¡ã—ã€ãã‚Œã‚’é›»å­ä¿¡å·ã«å¤‰æ›ã—ã¾ã™ã€‚

å¿…è¦ãªéƒ¨å“
------------------------------

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ä»¥ä¸‹ã®éƒ¨å“ãŒå¿…è¦ã§ã™ã€‚

.. image:: ../img/list_2.2.5.png

ã‚­ãƒƒãƒˆå…¨ä½“ã‚’è³¼å…¥ã™ã‚‹ã®ã¯ç¢ºã‹ã«ä¾¿åˆ©ã§ã™ã€‚ã“ã¡ã‚‰ãŒãƒªãƒ³ã‚¯ã§ã™ï¼š

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - åå‰
        - ã“ã®ã‚­ãƒƒãƒˆã®ã‚¢ã‚¤ãƒ†ãƒ 
        - ãƒªãƒ³ã‚¯
    *   - Raphael Kit
        - 337
        - |link_Raphael_kit|

ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å€‹åˆ¥ã«è³¼å…¥ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç´¹ä»‹
        - è³¼å…¥ãƒªãƒ³ã‚¯

    *   - :ref:`cpn_gpio_board`
        - |link_gpio_board_buy|
    *   - :ref:`cpn_breadboard`
        - |link_breadboard_buy|
    *   - :ref:`cpn_wires`
        - |link_wires_buy|
    *   - :ref:`cpn_ultrasonic_sensor`
        - |link_ultrasonic_buy|

å›è·¯å›³
-----------------

.. image:: ../img/image329.png


å®Ÿé¨“æ‰‹é †
-----------------------

**ã‚¹ãƒ†ãƒƒãƒ—1:** å›è·¯ã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚

.. image:: ../img/image220.png

**ã‚¹ãƒ†ãƒƒãƒ—2:** ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã€‚

.. raw:: html

   <run></run>

.. code-block::

    cd ~/raphael-kit/c/2.2.8/

**ã‚¹ãƒ†ãƒƒãƒ—3:** ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚

.. raw:: html

   <run></run>

.. code-block::

    gcc 2.2.8_Ultrasonic.c -lwiringPi

**ã‚¹ãƒ†ãƒƒãƒ—4:** å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

.. raw:: html

   <run></run>

.. code-block::

    sudo ./a.out

ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å‰æ–¹ã®éšœå®³ç‰©ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ã¨ã®è·é›¢ã‚’æ¤œå‡ºã—ã€ãã®è·é›¢å€¤ãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

.. note::

    å®Ÿè¡Œå¾Œã«å‹•ä½œã—ãªã„ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ŒwiringPi.h: No such file or directoryã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€ :ref:`install_wiringpi_pi5` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

**ã‚³ãƒ¼ãƒ‰**

.. code-block:: c

    #include <wiringPi.h>
    #include <stdio.h>
    #include <sys/time.h>

    #define Trig    4
    #define Echo    5

    void ultraInit(void)
    {
        pinMode(Echo, INPUT);
        pinMode(Trig, OUTPUT);
    }

    float disMeasure(void)
    {
        struct timeval tv1;
        struct timeval tv2;
        long time1, time2;
    float dis;

        digitalWrite(Trig, LOW);
        delayMicroseconds(2);

        digitalWrite(Trig, HIGH);
        delayMicroseconds(10);      
        digitalWrite(Trig, LOW);
                                    
        while(!(digitalRead(Echo) == 1));   
        gettimeofday(&tv1, NULL);           

        while(!(digitalRead(Echo) == 0));   
        gettimeofday(&tv2, NULL);           

        time1 = tv1.tv_sec * 1000000 + tv1.tv_usec;   
        time2  = tv2.tv_sec * 1000000 + tv2.tv_usec;

        dis = (float)(time2 - time1) / 1000000 * 34000 / 2;  

        return dis;
    }

    int main(void)
    {
        float dis;
        if(wiringPiSetup() == -1){ //when initialize wiring failed,print message to screen
            printf("setup wiringPi failed !");
            return 1;
        }

        ultraInit();
        
        while(1){
            dis = disMeasure();
            printf("%0.2f cm\n\n",dis);
            delay(300);
        }

        return 0;
    }

**ã‚³ãƒ¼ãƒ‰èª¬æ˜**

.. code-block:: c

    void ultraInit(void)
    {
        pinMode(Echo, INPUT);
        pinMode(Trig, OUTPUT);
    }

è¶…éŸ³æ³¢ãƒ”ãƒ³ã‚’åˆæœŸåŒ–ã—ã€åŒæ™‚ã«Echoã‚’å…¥åŠ›ã«ã€Trigã‚’å‡ºåŠ›ã«è¨­å®šã—ã¾ã™ã€‚

.. code-block:: c

    float disMeasure(void){};

ã“ã®é–¢æ•°ã¯ã€æˆ»ã‚Šæ¤œå‡ºè·é›¢ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã§è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

.. code-block:: c

    struct timeval tv1;
    struct timeval tv2;

struct timevalã¯ã€ç¾åœ¨ã®æ™‚åˆ»ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹æ§‹é€ ä½“ã§ã™ã€‚å®Œå…¨ãªæ§‹é€ ä½“ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

.. code-block:: c

    struct timeval
    {
    __time_t tv_sec;        /* Seconds. */
    __suseconds_t tv_usec;  /* Microseconds. */
    };

ã“ã“ã§ã€tv_secã¯EpochãŒstruct timevalã‚’ä½œæˆã—ãŸéš›ã®ç§’ã‚’è¡¨ã—ã€tv_usecã¯ãƒã‚¤ã‚¯ãƒ­ç§’ã¾ãŸã¯ç§’ã®ä¸€éƒ¨ã‚’è¡¨ã—ã¾ã™ã€‚

.. code-block:: c

    digitalWrite(Trig, HIGH);
    delayMicroseconds(10);     
    digitalWrite(Trig, LOW);

10usã®è¶…éŸ³æ³¢ãƒ‘ãƒ«ã‚¹ãŒé€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚

.. code-block:: c

    while(!(digitalRead(Echo) == 1));
    gettimeofday(&tv1, NULL);

ã“ã®ç©ºã®ãƒ«ãƒ¼ãƒ—ã¯ã€ãƒˆãƒªã‚¬ãƒ¼ã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡ã—ãŸã¨ãã«å¹²æ¸‰ã™ã‚‹ã‚¨ã‚³ãƒ¼ã‚·ã‚°ãƒŠãƒ«ãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ã€ç¾åœ¨ã®æ™‚é–“ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

.. code-block:: c

    while(!(digitalRead(Echo) == 0)); 
    gettimeofday(&tv2, NULL);

ã“ã®ç©ºã®ãƒ«ãƒ¼ãƒ—ã¯ã€ã‚¨ã‚³ãƒ¼ã‚·ã‚°ãƒŠãƒ«ãŒå—ä¿¡ã•ã‚Œã‚‹ã¾ã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€ãã—ã¦ç¾åœ¨ã®æ™‚é–“ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

.. code-block:: c

    time1 = tv1.tv_sec * 1000000 + tv1.tv_usec;
    time2  = tv2.tv_sec * 1000000 + tv2.tv_usec;

struct timevalã§ä¿å­˜ã•ã‚ŒãŸæ™‚é–“ã‚’å®Œå…¨ãªãƒã‚¤ã‚¯ãƒ­ç§’ã®æ™‚é–“ã«å¤‰æ›ã—ã¾ã™ã€‚

.. code-block:: c

    dis = (float)(time2 - time1) / 1000000 * 34000 / 2;  

æ™‚é–“é–“éš”ã¨éŸ³ã®ä¼æ’­é€Ÿåº¦ã«ã‚ˆã£ã¦è·é›¢ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚ç©ºæ°—ä¸­ã®éŸ³ã®é€Ÿåº¦ï¼š34000cm/sã€‚

ç¾è±¡ã®ç”»åƒ
------------------

.. image:: ../img/image221.jpeg