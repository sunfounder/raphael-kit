.. note::

    춰Hola, bienvenido a la Comunidad de Entusiastas de SunFounder Raspberry Pi, Arduino y ESP32 en Facebook! Profundiza en Raspberry Pi, Arduino y ESP32 con otros entusiastas.

    **쯇or qu칠 unirse?**

    - **Soporte experto**: Resuelve problemas postventa y desaf칤os t칠cnicos con la ayuda de nuestra comunidad y equipo.
    - **Aprende y comparte**: Intercambia consejos y tutoriales para mejorar tus habilidades.
    - **Previews exclusivos**: Accede anticipadamente a anuncios de nuevos productos y adelantos exclusivos.
    - **Descuentos especiales**: Disfruta de descuentos exclusivos en nuestros productos m치s recientes.
    - **Promociones y sorteos festivos**: Participa en sorteos y promociones de temporada.

    游녤 쯃isto para explorar y crear con nosotros? Haz clic en [|link_sf_facebook|] y 칰nete hoy mismo.

.. _3.1.2_py:

3.1.2 M칩dulo de Video
=========================

Introducci칩n
-----------------

Adem치s de tomar fotos, el m칩dulo de c치mara tambi칠n puede usarse para grabar videos.

Componentes necesarios
------------------------------

En este proyecto, necesitamos los siguientes componentes. 

.. image:: ../img/photo1.png
  :width: 800

Es definitivamente conveniente comprar un kit completo, aqu칤 est치 el enlace: 

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - Nombre	
        - ELEMENTOS EN ESTE KIT
        - ENLACE
    *   - Kit Raphael
        - 337
        - |link_Raphael_kit|

Tambi칠n puedes comprarlos por separado en los enlaces a continuaci칩n.

.. list-table::
    :widths: 30 20
    :header-rows: 1

    *   - INTRODUCCI칍N DEL COMPONENTE
        - ENLACE DE COMPRA

    *   - :ref:`cpn_camera_module`
        - |link_camera_buy|

Procedimientos experimentales
---------------------------------

**Paso 1:** Accede al escritorio de Raspberry Pi. Puede que necesites una pantalla para una mejor experiencia, consulta: `Conecta tu Raspberry Pi <https://projects.raspberrypi.org/en/projects/raspberry-pi-setting-up/3>`_. O accede al escritorio de Raspberry Pi de forma remota, para un tutorial detallado, consulta :ref:`remote_desktop`.

**Paso 2:** Abre un terminal y accede a la carpeta del c칩digo.

.. code-block::

    cd ~/raphael-kit/python/

**Paso 3:** Ejecuta el c칩digo.

.. code-block::

    sudo python3 3.1.2_VideoModule.py

Ejecuta el c칩digo para comenzar la grabaci칩n. Presiona ``Ctrl+C`` para terminar la grabaci칩n. Nombra el video ``my_video.h264`` y almac칠nalo en el directorio ``~``.

.. note::

    Tambi칠n puedes abrir ``3.1.2_VideoModule.py`` en la ruta ``~/raphael-kit/python/`` con un IDE de Python, hacer clic en el bot칩n de Ejecutar para ejecutar el c칩digo y detenerlo con el bot칩n de Detener.

Si deseas enviar fotos a tu PC, consulta :ref:`filezilla`.

.. code-block:: python

   #!/usr/bin/env python3

   import time
   from picamera2 import Picamera2, Preview
   from picamera2.encoders import H264Encoder
   from picamera2.outputs import FfmpegOutput
   import os

   # Get the current user's login name
   user = os.getlogin()
   # Get the path to the user's home directory
   user_home = os.path.expanduser(f'~{user}')

   # Create a Picamera2 instance
   camera = Picamera2()
   # Retrieve the default preview configuration
   preview_config = camera.preview_configuration

   try:
       # Configure preview size and format
       preview_config.size = (800, 600)
       preview_config.format = 'XRGB8888'
       # Start the camera preview in QTGL mode
       camera.start_preview(Preview.QTGL)

       # Define video configuration with size, frame rate, and buffer count
       conf = {'size': (800, 600)}
       controls = {'FrameRate': 40}
       config = camera.create_video_configuration(main=conf, controls=controls, buffer_count=12)
       # Create a video encoder with a specified bitrate
       encoder = H264Encoder(bitrate=10000000)
       # Define output file for the video
       output = FfmpegOutput(f'{user_home}/my_video.mp4')
       # Configure and start recording
       camera.configure(config)
       camera.start_recording(encoder, output)
       # Record for 10 seconds
       time.sleep(10)
       # Stop the recording
       camera.stop_recording()

   except KeyboardInterrupt:
       # Stop the camera preview if a KeyboardInterrupt (e.g., Ctrl+C) occurs
       camera.stop_preview()
       pass

**Explicaci칩n del c칩digo**

#. Importa las bibliotecas y clases necesarias.  
   La biblioteca ``picamera2`` se utiliza para controlar la c치mara, ``H264Encoder`` para la codificaci칩n de video y ``FfmpegOutput`` para definir el archivo de salida del video.

   .. code-block:: python

       #!/usr/bin/env python3

       import time
       from picamera2 import Picamera2, Preview
       from picamera2.encoders import H264Encoder
       from picamera2.outputs import FfmpegOutput
       import os

#. Obtiene el nombre de inicio de sesi칩n del usuario actual y la ruta a su directorio personal.

   .. code-block:: python

       # Obtener el nombre de usuario actual
       user = os.getlogin()
       # Obtener la ruta al directorio personal del usuario
       user_home = os.path.expanduser(f'~{user}')

#. Crea una instancia de la clase ``Picamera2`` y recupera la configuraci칩n predeterminada de vista previa.

   .. code-block:: python

       # Crear una instancia de Picamera2
       camera = Picamera2()
       # Recuperar la configuraci칩n predeterminada de la vista previa
       preview_config = camera.preview_configuration

#. Establece el tama침o y el formato de la vista previa de la c치mara.  
   El tama침o se establece en 800x600 p칤xeles y el formato en ``XRGB8888``.

   .. code-block:: python

       try:
           # Configurar tama침o y formato de la vista previa
           preview_config.size = (800, 600)
           preview_config.format = 'XRGB8888'

#. Inicia la vista previa de la c치mara en modo QTGL, un modo gr치fico de visualizaci칩n.

   .. code-block:: python

       try:
           ...
           
           # Iniciar la vista previa en modo QTGL
           camera.start_preview(Preview.QTGL)

           ...

#. Define la configuraci칩n de video con un tama침o de cuadro de 800x600 p칤xeles y una tasa de 40 fotogramas por segundo.

   .. code-block:: python

       try:
           ...
           
           # Definir configuraci칩n de video con tama침o, tasa de fotogramas y n칰mero de b칰feres
           conf = {'size': (800, 600)}
           controls = {'FrameRate': 40}
           config = camera.create_video_configuration(main=conf, controls=controls, buffer_count=12)

           ...

#. Crea un codificador de video con una tasa de bits de 10 Mbps usando el formato H.264.  
   Define la ruta del archivo de salida, guard치ndolo como ``my_video.mp4`` en el directorio personal del usuario.

   .. code-block:: python

       try:
           ...

           # Crear un codificador de video con una tasa de bits espec칤fica
           encoder = H264Encoder(bitrate=10000000)
           # Definir archivo de salida del video
           output = FfmpegOutput(f'{user_home}/my_video.mp4')

           ...

#. Configura la c치mara con los ajustes de video definidos, inicia la grabaci칩n usando el codificador y el archivo de salida, graba durante 10 segundos y luego detiene la grabaci칩n.

   .. code-block:: python

       try:
           ...

           # Configurar e iniciar la grabaci칩n
           camera.configure(config)
           camera.start_recording(encoder, output)
           # Grabar durante 10 segundos
           time.sleep(10)
           # Detener la grabaci칩n
           camera.stop_recording()

#. Este bloque de c칩digo maneja una interrupci칩n de teclado (como Ctrl+C) deteniendo la vista previa de la c치mara.  
   La instrucci칩n ``pass`` se utiliza para manejar la excepci칩n sin realizar acciones adicionales.

   .. code-block:: python

       except KeyboardInterrupt:
           # Detener la vista previa si ocurre un KeyboardInterrupt (ej., Ctrl+C)
           camera.stop_preview()
           pass

